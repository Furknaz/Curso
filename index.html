<!DOCTYPE html>
<html lang="pt-br">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>FS - Curso de Empréstimo Consignado</title>
    <link rel="stylesheet" href="css/style.css" />
    <script src="https://js.stripe.com/v3/"></script>
  </head>
  <body>
    <!-- Streaming Platform Header -->
    <header class="header">
      <div class="header-content">
        <div class="logo">
          <div class="logo-icon">img</div>
          <div class="logo-text">FS FINANCE GROUP</div>
        </div>
        <nav class="main-nav">
          <ul>
            <li><a href="#home" class="active">Início</a></li>
            <li><a href="#courses">Cursos</a></li>
            <li><a href="profile.html">Meu Progresso</a></li>
            <li><a href="cart.html">Carrinho</a></li>
          </ul>
        </nav>
        <div class="header-actions">
          <div class="search-container">
            <input
              type="text"
              placeholder="Buscar cursos..."
              class="search-bar"
            />
          </div>
          <div class="profile-dropdown">
            <button class="profile-button" id="profileButton">
              <img src="images/profile-icon.png" alt="Profile" class="profile-icon" />
            </button>
            <div class="profile-dropdown-content" id="profileDropdownContent">
              <a href="profile.html">Meu Perfil</a>
              <a href="login.html" id="loginLink">Login</a>
              <a href="register.html" id="registerLink">Registrar</a>
              <a href="#" id="logoutLink" style="display: none;">Sair</a>
            </div>
          </div>
        </div>
      </div>
    </header>

    <section class="hero-section" id="home">
      <div class="hero-background">
        <div class="hero-overlay"></div>
        <div class="hero-content">
          <div class="hero-info">
            <h2 class="hero-title">Curso Completo de Empréstimo Consignado</h2>
            <p class="hero-description">
              Domine todas as técnicas e estratégias para se tornar um
              especialista em empréstimos consignados. 7 módulos completos com
              aulas práticas e cases reais do mercado.
            </p>
            <div class="hero-stats">
              <span class="stat-item">★ 4.9/5</span>
              <span class="stat-item">◉ 2.847 alunos</span>
              <span class="stat-item">■ 7 módulos</span>
              <span class="stat-item">○ 12h de conteúdo</span>
            </div>
            <div class="hero-actions">
              <button class="btn-primary" onclick="scrollToCourses()">
                ▶ Começar Agora
              </button>
              <button class="btn-secondary" onclick="openModal('modulo1')">
                ℹ Mais Informações
              </button>
            </div>
          </div>
          <div class="hero-preview">
            <div class="preview-card">
              <div class="preview-image">
                <span class="play-icon">▶</span>
              </div>
              <h3>Preview do Curso</h3>
              <p>Veja uma amostra do que você vai aprender</p>
            </div>
          </div>
        </div>
      </div>
    </section>

    <main class="main-container">
      <!-- Course Categories Section -->
      <section class="courses-section" id="courses">
        <div class="section-header">
          <h2 class="section-title">Módulos do Curso</h2>
          <div class="category-filters">
            <button class="filter-btn active" data-category="all">Todos</button>
            <button class="filter-btn" data-category="fundamentos">
              Fundamentos
            </button>
            <button class="filter-btn" data-category="pratica">Prática</button>
            <button class="filter-btn" data-category="avancado">
              Avançado
            </button>
          </div>
        </div>

        <!-- Modules Grid -->
        <div class="modules-grid">
          <!-- Module 1 -->
          <div
            class="streaming-card"
            data-category="fundamentos"
            data-module-id="modulo1"
            data-price="49.90"
          >
            <div
              class="card-image"
              style="
                background-image: url('images/Objeções.png');
                background-size: cover;
                background-position: center;
              "
            >
              <div class="module-badge">MÓDULO 1</div>
              <div class="card-overlay">
                <button class="play-button" onclick="openModal('modulo1')">▶</button>
              </div>
              <div class="progress-bar">
                <div class="progress-fill" style="width: 0%"></div>
              </div>
            </div>
            <div class="card-content">
              <h3 class="card-title">Contornar Objeções</h3>
              <p class="card-description">
                Técnicas avançadas para superar resistências
              </p>
              <div class="card-meta">
                <span class="duration">○ 1h 45min</span>
                <span class="lessons">■ 4 aulas</span>
                <span class="rating">★ 4.8</span>
              </div>
              <button class="buy-btn btn-primary add-to-cart-btn" data-module-id="modulo1" data-module-name="Módulo 1: Contornar Objeções" data-price="49.90">Comprar</button>
            </div>
          </div>

          <!-- Module 2 -->
          <div
            class="streaming-card"
            data-category="pratica"
            data-module-id="modulo2"
            data-price="59.90"
          >
            <div
              class="card-image"
              style="
                background-image: url('images/Tecnica.png');
                background-size: cover;
                background-position: center;
              "
            >
              <div class="module-badge">MÓDULO 2</div>
              <div class="card-overlay">
                <button class="play-button" onclick="openModal('modulo2')">▶</button>
              </div>
              <div class="progress-bar">
                <div class="progress-fill" style="width: 0%"></div>
              </div>
            </div>
            <div class="card-content">
              <h3 class="card-title">Técnica de Vendas</h3>
              <p class="card-description">Habilidades fundamentais de vendas</p>
              <div class="card-meta">
                <span class="duration">○ 2h 10min</span>
                <span class="lessons">■ 4 aulas</span>
                <span class="rating">★ 4.9</span>
              </div>
              <button class="buy-btn btn-primary add-to-cart-btn" data-module-id="modulo2" data-module-name="Módulo 2: Técnica de Vendas" data-price="59.90">Comprar</button>
            </div>
          </div>

          <!-- Module 3 -->
          <div
            class="streaming-card"
            data-category="pratica"
            data-module-id="modulo3"
            data-price="49.90"
          >
            <div
              class="card-image"
              style="
                background-image: url('images/Persuasão.png');
                background-size: cover;
                background-position: center;
              "
            >
              <div class="module-badge">MÓDULO 3</div>
              <div class="card-overlay">
                <button class="play-button" onclick="openModal('modulo3')">▶</button>
              </div>
              <div class="progress-bar">
                <div class="progress-fill" style="width: 0%"></div>
              </div>
            </div>
            <div class="card-content">
              <h3 class="card-title">Técnicas de Persuasão</h3>
              <p class="card-description">Arte da persuasão ética aplicada</p>
              <div class="card-meta">
                <span class="duration">○ 1h 30min</span>
                <span class="lessons">■ 4 aulas</span>
                <span class="rating">★ 4.7</span>
              </div>
              <button class="buy-btn btn-primary add-to-cart-btn" data-module-id="modulo3" data-module-name="Módulo 3: Técnicas de Persuasão" data-price="49.90">Comprar</button>
            </div>
          </div>

          <!-- Module 4 -->
          <div
            class="streaming-card"
            data-category="avancado"
            data-module-id="modulo4"
            data-price="69.90"
          >
            <div
              class="card-image"
              style="
                background-image: url('images/Produtos.png');
                background-size: cover;
                background-position: center;
              "
            >
              <div class="module-badge">MÓDULO 4</div>
              <div class="card-overlay">
                <button class="play-button" onclick="openModal('modulo4')">▶</button>
              </div>
              <div class="progress-bar">
                <div class="progress-fill" style="width: 0%"></div>
              </div>
            </div>
            <div class="card-content">
              <h3 class="card-title">Produtos</h3>
              <p class="card-description">
                Conhecimento dos produtos consignados
              </p>
              <div class="card-meta">
                <span class="duration">○ 2h 20min</span>
                <span class="lessons">■ 3 aulas</span>
                <span class="rating">★ 4.9</span>
              </div>
              <button class="buy-btn btn-primary add-to-cart-btn" data-module-id="modulo4" data-module-name="Módulo 4: Produtos" data-price="69.90">Comprar</button>
            </div>
          </div>

          <!-- Module 5 -->
          <div
            class="streaming-card"
            data-category="avancado"
            data-module-id="modulo5"
            data-price="39.90"
          >
            <div
              class="card-image"
              style="
                background-image: url('images/Mapeamento.png');
                background-size: cover;
                background-position: center;
              "
            >
              <div class="module-badge">MÓDULO 5</div>
              <div class="card-overlay">
                <button class="play-button" onclick="openModal('modulo5')">▶</button>
              </div>
              <div class="progress-bar">
                <div class="progress-fill" style="width: 0%"></div>
              </div>
            </div>
            <div class="card-content">
              <h3 class="card-title">Mapeamento de Meta</h3>
              <p class="card-description">Planejamento estratégico pessoal</p>
              <div class="card-meta">
                <span class="duration">○ 1h 55min</span>
                <span class="lessons">■ 3 aulas</span>
                <span class="rating">★ 4.8</span>
              </div>
              <button class="buy-btn btn-primary add-to-cart-btn" data-module-id="modulo5" data-module-name="Módulo 5: Mapeamento de Meta" data-price="39.90">Comprar</button>
            </div>
          </div>

          <!-- Module 6 -->
          <div
            class="streaming-card"
            data-category="avancado"
            data-module-id="modulo6"
            data-price="79.90"
          >
            <div
              class="card-image"
              style="
                background-image: url('images/Digitação.png');
                background-size: cover;
                background-position: center;
              "
            >
              <div class="module-badge">MÓDULO 6</div>
              <div class="card-overlay">
                <button class="play-button" onclick="openModal('modulo6')">▶</button>
              </div>
              <div class="progress-bar">
                <div class="progress-fill" style="width: 0%"></div>
              </div>
            </div>
            <div class="card-content">
              <h3 class="card-title">Digitação Banco e Ecorban</h3>
              <p class="card-description">Sistemas bancários e plataformas</p>
              <div class="card-meta">
                <span class="duration">○ 1h 40min</span>
                <span class="lessons">■ 4 aulas</span>
                <span class="rating">★ 4.6</span>
              </div>
              <button class="buy-btn btn-primary add-to-cart-btn" data-module-id="modulo6" data-module-name="Módulo 6: Digitação Banco e Ecorban" data-price="79.90">Comprar</button>
            </div>
          </div>

          <!-- Module 7 -->
          <div
            class="streaming-card"
            data-category="avancado"
            data-module-id="modulo7"
            data-price="89.90"
          >
            <div
              class="card-image"
              style="
                background-image: url('images/Esteira.png');
                background-size: cover;
                background-position: center;
              "
            >
              <div class="module-badge">MÓDULO 7</div>
              <div class="card-overlay">
                <button class="play-button" onclick="openModal('modulo7')">▶</button>
              </div>
              <div class="progress-bar">
                <div class="progress-fill" style="width: 0%"></div>
              </div>
            </div>
            <div class="card-content">
              <h3 class="card-title">Acompanhamento de Esteira</h3>
              <p class="card-description">
                Gerenciamento do processo de aprovação
              </p>
              <div class="card-meta">
                <span class="duration">○ 2h 30min</span>
                <span class="lessons">■ 4 aulas</span>
                <span class="rating">★ 5.0</span>
              </div>
              <button class="buy-btn btn-primary add-to-cart-btn" data-module-id="modulo7" data-module-name="Módulo 7: Acompanhamento de Esteira" data-price="89.90">Comprar</button>
            </div>
          </div>
        </div>
      </section>
    </main>

    <!-- Modal Structure -->
    <div id="moduleModal" class="modal">
      <div class="modal-content">
        <span class="close" onclick="closeModal()">&times;</span>
        <div class="modal-header">
          <img id="modalImage" src="" alt="" />
          <div class="modal-info">
            <h1 id="modalTitle"></h1>
            <div class="modal-meta">
              <div>
                <span id="modalYear">2025</span>
                <span class="age-rating">A14</span>
                <span class="genre">Série</span>
              </div>
              <div>
                <span class="category">Educação</span>
                <span class="category">Vendas</span>
              </div>
            </div>
            <p id="modalDescription"></p>
            <button
              id="accessButton"
              class="access-btn"
              onclick="accessModule()"
            >
              Vamos lá <span class="arrow">▶</span>
            </button>
          </div>
        </div>
      </div>
    </div>

    <script src="js/moduleData.js"></script>
    <script>
      let purchasedCourses = new Set();
      let currentUser = null;
      let currentModalModuleId = null;

      // --- CORE LOGIC ---

      document.addEventListener("DOMContentLoaded", function () {
        updateUIBasedOnLogin();
        initializeEventListeners();
      });

      async function updateUIBasedOnLogin() {
        const userString = localStorage.getItem('loggedInUser');
        if (userString) {
          currentUser = JSON.parse(userString);
        } else {
          currentUser = null;
        }

        if (currentUser && currentUser.id) {
          try {
            const response = await fetch(`/api/get-user-courses?userId=${currentUser.id}`);
            if (response.ok) {
              const data = await response.json();
              purchasedCourses = new Set(data.courses.map(c => c.id));
            } else {
              console.error('Failed to get user courses, server responded with:', response.status);
            }
          } catch (error) {
            console.error('Error fetching user courses:', error);
          }
        } else {
          purchasedCourses.clear();
        }
        
        updateAllModuleCards();
      }

      function updateAllModuleCards() {
        const streamingCards = document.querySelectorAll('.streaming-card');
        streamingCards.forEach(card => {
          const moduleId = card.getAttribute('data-module-id');
          const buyButton = card.querySelector('.buy-btn');
          const playButton = card.querySelector('.play-button');

          // The play button should always open the modal to show module details
          if (playButton) {
            playButton.onclick = (e) => {
              e.stopPropagation();
              openModal(moduleId);
            };
          }

          if (purchasedCourses.has(moduleId)) {
            // USER OWNS THIS COURSE
            if (buyButton) {
              buyButton.textContent = 'Acessar';
              buyButton.disabled = false;
              buyButton.style.backgroundColor = '#5cb85c'; // Green
              buyButton.style.cursor = 'pointer';
              buyButton.classList.remove('add-to-cart-btn');
              buyButton.onclick = (e) => {
                e.stopPropagation();
                navigateToModule(moduleId);
              };
            }
          } else {
            // USER DOES NOT OWN THIS COURSE
            if (buyButton) {
              buyButton.textContent = 'Comprar';
              buyButton.disabled = false;
              buyButton.style.backgroundColor = ''; // Reset to default
              buyButton.style.cursor = 'pointer';
              buyButton.classList.add('add-to-cart-btn');
              // Let the generic cart.js logic handle the click
              buyButton.onclick = null; 
            }
          }
        });
      }

      function navigateToModule(moduleId) {
        if (moduleId && moduleData[moduleId]) {
          if (purchasedCourses.has(moduleId)) {
            window.location.href = moduleData[moduleId].url;
          } else {
            alert('Você precisa comprar este módulo para acessá-lo.');
            // Optionally, redirect to the course sales page or do nothing
          }
        }
      }

      // --- MODAL LOGIC (largely for info now) ---

      function openModal(moduleId) {
        const module = moduleData[moduleId];
        if (module) {
          currentModalModuleId = moduleId;
          document.getElementById("modalTitle").textContent = module.title;
          document.getElementById("modalDescription").textContent = module.description;
          document.getElementById("modalImage").src = module.image;
          
          const accessButton = document.getElementById("accessButton");
          if (purchasedCourses.has(moduleId)) {
            accessButton.textContent = 'Acessar Módulo';
            accessButton.onclick = () => {
              closeModal();
              navigateToModule(moduleId);
            };
          } else {
            accessButton.textContent = 'Adicionar ao Carrinho';
            accessButton.onclick = () => {
                window.addToCart(module.id, module.title, module.price);
                closeModal();
                alert('Curso adicionado ao carrinho!');
            };
          }

          document.getElementById("moduleModal").style.display = "block";
          document.body.style.overflow = "hidden";
        }
      }

      function closeModal() {
        document.getElementById("moduleModal").style.display = "none";
        document.body.style.overflow = "auto";
      }

      // --- PRESERVED EVENT LISTENERS & HELPERS ---

      function initializeEventListeners() {
        // Category filter
        const filterButtons = document.querySelectorAll(".filter-btn");
        const streamingCards = document.querySelectorAll(".streaming-card");
        filterButtons.forEach(button => {
          button.addEventListener("click", function () {
            filterButtons.forEach(btn => btn.classList.remove("active"));
            this.classList.add("active");
            const category = this.getAttribute("data-category");
            streamingCards.forEach(card => {
              if (category === "all" || card.getAttribute("data-category") === category) {
                card.style.display = "block";
              } else {
                card.style.display = "none";
              }
            });
          });
        });

        // Modal close events
        window.onclick = (event) => {
          const modal = document.getElementById("moduleModal");
          if (event.target === modal) closeModal();
        };
        document.addEventListener("keydown", (event) => {
          if (event.key === "Escape") closeModal();
        });

        // Search bar
        document.querySelector('.search-bar').addEventListener('input', function() {
          const searchTerm = removeAccents(this.value.toLowerCase());
          const streamingCards = document.querySelectorAll('.streaming-card');
          const threshold = 2;
          streamingCards.forEach(card => {
            const title = removeAccents(card.querySelector('.card-title').textContent.toLowerCase());
            const description = removeAccents(card.querySelector('.card-description').textContent.toLowerCase());
            const titleDistance = levenshtein(searchTerm, title);
            const descriptionDistance = levenshtein(searchTerm, description);
            if (title.includes(searchTerm) || description.includes(searchTerm) || titleDistance <= threshold || descriptionDistance <= threshold) {
              card.style.display = 'block';
            } else {
              card.style.display = 'none';
            }
          });
        });

        // Nav scroll behavior
        const navLinks = document.querySelectorAll('.main-nav a');
        const sections = document.querySelectorAll('section');
        window.addEventListener('scroll', () => {
          let current = '';
          sections.forEach(section => {
            const sectionTop = section.offsetTop;
            if (pageYOffset >= sectionTop - 60) {
              current = section.getAttribute('id');
            }
          });
          navLinks.forEach(link => {
            link.classList.remove('active');
            if (link.getAttribute('href').includes(current)) {
              link.classList.add('active');
            }
          });
        });
      }

      function scrollToCourses() {
        document.getElementById("courses")?.scrollIntoView({ behavior: "smooth", block: "start" });
      }

      function levenshtein(a, b) {
        if (a.length === 0) return b.length;
        if (b.length === 0) return a.length;
        const matrix = [];
        for (let i = 0; i <= b.length; i++) { matrix[i] = [i]; }
        for (let j = 0; j <= a.length; j++) { matrix[0][j] = j; }
        for (let i = 1; i <= b.length; i++) {
          for (let j = 1; j <= a.length; j++) {
            if (b.charAt(i - 1) === a.charAt(j - 1)) {
              matrix[i][j] = matrix[i - 1][j - 1];
            } else {
              matrix[i][j] = Math.min(matrix[i - 1][j - 1] + 1, matrix[i][j - 1] + 1, matrix[i - 1][j] + 1);
            }
          }
        }
        return matrix[b.length][a.length];
      }

      function removeAccents(str) {
        return str.normalize("NFD").replace(/[̀-ͯ]/g, "");
      }
    </script>
    <script src="js/auth.js"></script>
    <script src="js/cart.js" defer></script>
  </body>
</html>
